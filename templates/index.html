from flask import Flask, render_template, request, jsonify
from flask_cors import CORS
import json
from sentence_transformers import SentenceTransformer, util
import torch

app = Flask(__name__, static_folder='static', template_folder='templates')
CORS(app)

# ‚úÖ Load knowledge base
with open('chatbot_knowledge.json', 'r', encoding='utf-8') as f:
    knowledge_base = json.load(f)

# ‚úÖ Load semantic model
model = SentenceTransformer('all-MiniLM-L6-v2')
kb_questions = [item['question'] for item in knowledge_base]
kb_embeddings = model.encode(kb_questions, convert_to_tensor=True)

# ‚úÖ Find answer using semantic similarity
def find_answer_semantic(user_input):
    user_embedding = model.encode(user_input, convert_to_tensor=True)
    cos_scores = util.pytorch_cos_sim(user_embedding, kb_embeddings)[0]
    best_match_idx = torch.argmax(cos_scores).item()
    best_score = cos_scores[best_match_idx].item()

    print(f"üß† Semantic Similarity Score: {best_score:.2f}")
    if best_score > 0.6:
        best_item = knowledge_base[best_match_idx]
        response = best_item['answer']
        if best_item.get('link'):
            response += f'<br><a href="{best_item["link"]}" target="_blank">Click here for more info</a>'
        return response
    else:
        log_unanswered_question(user_input)
        return "I'm not sure how to answer that. Please try rephrasing your question."

# ‚úÖ Log unanswered questions for review
def log_unanswered_question(user_input):
    with open("unanswered.log", "a", encoding="utf-8") as f:
        f.write(user_input + "\n")

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/default-message', methods=['GET'])
def default_message():
    return jsonify({"response": "Hi! I'm the CMLI chatbot. Ask me anything about our research!"})

@app.route('/chat', methods=['POST'])
def chat():
    try:
        user_input = request.json.get("message", "").strip().lower()
        if not user_input:
            return jsonify({"response": "Please provide a valid message."})

        answer = find_answer_semantic(user_input)
        return jsonify({"response": answer})

    except Exception as e:
        print(f"‚ùå Chat Error: {e}")
        return jsonify({"response": "An internal error occurred."})

if __name__ == '__main__':
    app.run(debug=True)
